<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body><table xmlns:com="http://schemas.tranzaxis.com/common-types.xsd" data-page-item="" crid="40817810200000055320" class="tblBlock tbl-inform" cellspacing="0" border="0" data-contract-properties='{"TypeId":"885","Id":"102233","Rid":"40817810200000055320","Status":"Active","Ccy":"810"}' data-contract-extra-properties='{"hasPayrollLink":false}'><tbody>
<tr class="trHeader"><th colspan="6" class="blockName"><div class="row">
<div class="small-3 column caption-table contract">
<div class="caption-text">Счёт</div>
<div class="caption-hint">40817810200000055320</div>
</div>
<div class="small-2 column wrapper-moreaction right"><div class="row"><div class="small-4 column right">
<div title="Дополнительно" data-dropdown="drop-action" data-options="align:left" class="information open" aria-expanded="true"></div>
<ul data-dropdown-content="" class="f-dropdown dropdown-list moreaction open drop-left f-open-dropdown" id="drop-action" style="position: absolute; left: -185px; top: 0px;" aria-hidden="false">
<li class="pic"><div><div class="text">Баланс</div></div></li>
<li><div class="leger-balance text-right"><div id="moreContractLedgerBalance102233" class=""><div>1 000 000.00 ₽</div></div></div></li>
<li data-crid="40817810200000055320" class="pic operhist cp-action" data-action="get-statement"><div class="text">Список операций</div></li>
<li data-crid="40817810200000055320" class="pic bankdetails cp-action" data-action="show-bank-details"><div class="text">Реквизиты банка</div></li>
<li data-crid="40817810200000055320" class="pic dotransfer cp-action" data-action="make-transfer"><div class="text">Сделать перевод</div></li>
<li data-app-id="445" data-crid="40817810200000055320" data-action="application-withdrawal" class="pic cp-action create-application"><div class="text">Заказ денежных средств</div></li>
</ul>
</div></div></div>
</div></th></tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Описание счёта</td>
<td class="tdFieldVal"><div class="row" id="contract-title">
<div class="small-11 column" id="lnkContractTitle" ctitle="Счёт RUB">Счёт RUB</div>
<div class="small-1 column edit" data-action="change-contract-title"></div>
</div></td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Валюта</td>
<td class="tdFieldVal">Российский рубль</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Дата создания</td>
<td class="tdFieldVal">01.01.2020</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Статус</td>
<td class="tdFieldVal">Активный</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Доступный баланс</td>
<td class="tdFieldVal"><span>1 000 000.00 ₽</span></td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">В т.ч. собственных средств</td>
<td class="tdFieldVal">1 000 000.00 ₽</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">В т.ч. средств за счет овердрафта</td>
<td class="tdFieldVal">0.00 ₽</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Зарезервировано (расход)</td>
<td class="tdFieldVal"><span data-filter="Зарезервировано (расход)" data-crid="40817810200000055320" class="cp-link" data-action="get-statement-with-filter">0.00 ₽</span></td>
</tr>
<tr>
<td class="whitespace"> </td>
<td class="tdFieldName">Зарезервировано (поступления)</td>
<td class="tdFieldVal"><span data-filter="Зарезервировано (приход)" data-crid="40817810200000055320" class="cp-link" data-action="get-statement-with-filter">0.00 ₽</span></td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Задолженность по комиссиям</td>
<td class="tdFieldVal">0.00 ₽</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Перерасход (несанкционированный овердрафт)</td>
<td class="tdFieldVal">0.00 ₽</td>
</tr>
</tbody></table></body></html>






<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body><table xmlns:com="http://schemas.tranzaxis.com/common-types.xsd" data-page-item="" crid="40817840400000055321" class="tblBlock tbl-inform" cellspacing="0" border="0" data-contract-properties='{"TypeId":"888","Id":"102234","Rid":"40817840400000055321","Status":"Active","Ccy":"840"}' data-contract-extra-properties='{"hasPayrollLink":false}'><tbody>
<tr class="trHeader"><th colspan="6" class="blockName"><div class="row">
<div class="small-3 column caption-table contract">
<div class="caption-text">Счёт</div>
<div class="caption-hint">40817840400000055321</div>
</div>
<div class="small-2 column wrapper-moreaction right"><div class="row"><div class="small-4 column right">
<div title="Дополнительно" data-dropdown="drop-action" data-options="align:left" class="information open" aria-expanded="true"></div>
<ul data-dropdown-content="" class="f-dropdown dropdown-list moreaction open drop-left f-open-dropdown" id="drop-action" style="position: absolute; left: -185px; top: 0px;" aria-hidden="false">
<li class="pic"><div><div class="text">Баланс</div></div></li>
<li><div class="leger-balance text-right"><div id="moreContractLedgerBalance102234" class="">
<div>100 000.00 $</div>
<div>
<span title="примерно">≈</span>7 482 000.00 ₽</div>
</div></div></li>
<li data-crid="40817840400000055321" class="pic operhist cp-action" data-action="get-statement"><div class="text">Список операций</div></li>
<li data-crid="40817840400000055321" class="pic bankdetails cp-action" data-action="show-bank-details"><div class="text">Реквизиты банка</div></li>
<li data-crid="40817840400000055321" class="pic dotransfer cp-action" data-action="make-transfer"><div class="text">Сделать перевод</div></li>
<li data-app-id="445" data-crid="40817840400000055321" data-action="application-withdrawal" class="pic cp-action create-application"><div class="text">Заказ денежных средств</div></li>
<li class="pic cp-action application-order" data-action="CMI::ContractsApplicationOrder:1"><div class="text">Заказ справки об остатке</div></li>
</ul>
</div></div></div>
</div></th></tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Описание счёта</td>
<td class="tdFieldVal"><div class="row" id="contract-title">
<div class="small-11 column" id="lnkContractTitle" ctitle="Счёт USD">Счёт USD</div>
<div class="small-1 column edit" data-action="change-contract-title"></div>
</div></td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Валюта</td>
<td class="tdFieldVal">Доллар США</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Дата создания</td>
<td class="tdFieldVal">01.01.2020</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Статус</td>
<td class="tdFieldVal">Активный</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Доступный баланс</td>
<td class="tdFieldVal"><span>100 000.00 $</span></td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">В т.ч. собственных средств</td>
<td class="tdFieldVal">100 000.00 $</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">В т.ч. средств за счет овердрафта</td>
<td class="tdFieldVal">0.00 $</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Зарезервировано (расход)</td>
<td class="tdFieldVal"><span data-filter="Зарезервировано (расход)" data-crid="40817840400000055321" class="cp-link" data-action="get-statement-with-filter">0.00 $</span></td>
</tr>
<tr>
<td class="whitespace"> </td>
<td class="tdFieldName">Зарезервировано (поступления)</td>
<td class="tdFieldVal"><span data-filter="Зарезервировано (приход)" data-crid="40817840400000055321" class="cp-link" data-action="get-statement-with-filter">0.00 $</span></td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Задолженность по комиссиям</td>
<td class="tdFieldVal">0.00 $</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Перерасход (несанкционированный овердрафт)</td>
<td class="tdFieldVal">0.00 $</td>
</tr>
</tbody></table></body></html>





<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body><table xmlns:com="http://schemas.tranzaxis.com/common-types.xsd" data-page-item="" crid="40817978300000055322" class="tblBlock tbl-inform" cellspacing="0" border="0" data-contract-properties='{"TypeId":"889","Id":"102235","Rid":"40817978300000055322","Status":"Active","Ccy":"978"}' data-contract-extra-properties='{"hasPayrollLink":false}'><tbody>
<tr class="trHeader"><th colspan="6" class="blockName"><div class="row">
<div class="small-3 column caption-table contract">
<div class="caption-text">Счёт</div>
<div class="caption-hint">40817978300000055322</div>
</div>
<div class="small-2 column wrapper-moreaction right"><div class="row"><div class="small-4 column right">
<div title="Дополнительно" data-dropdown="drop-action" data-options="align:left" class="information open" aria-expanded="true"></div>
<ul data-dropdown-content="" class="f-dropdown dropdown-list moreaction open drop-left f-open-dropdown" id="drop-action" style="position: absolute; left: -185px; top: 0px;" aria-hidden="false">
<li class="pic"><div><div class="text">Баланс</div></div></li>
<li><div class="leger-balance text-right"><div id="moreContractLedgerBalance102235" class="">
<div>100 000.00 €</div>
<div>
<span title="примерно">≈</span>9 099 000.00 ₽</div>
<div>
<span title="примерно">≈</span>122 380.00 $</div>
</div></div></li>
<li data-crid="40817978300000055322" class="pic operhist cp-action" data-action="get-statement"><div class="text">Список операций</div></li>
<li data-crid="40817978300000055322" class="pic bankdetails cp-action" data-action="show-bank-details"><div class="text">Реквизиты банка</div></li>
<li data-crid="40817978300000055322" class="pic dotransfer cp-action" data-action="make-transfer"><div class="text">Сделать перевод</div></li>
<li data-app-id="445" data-crid="40817978300000055322" data-action="application-withdrawal" class="pic cp-action create-application"><div class="text">Заказ денежных средств</div></li>
<li class="pic cp-action application-order" data-action="CMI::ContractsApplicationOrder:1"><div class="text">Заказ справки об остатке</div></li>
</ul>
</div></div></div>
</div></th></tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Описание счёта</td>
<td class="tdFieldVal"><div class="row" id="contract-title">
<div class="small-11 column" id="lnkContractTitle" ctitle="Счёт EUR">Счёт EUR</div>
<div class="small-1 column edit" data-action="change-contract-title"></div>
</div></td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Валюта</td>
<td class="tdFieldVal">Евро</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Дата создания</td>
<td class="tdFieldVal">01.01.2020</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Статус</td>
<td class="tdFieldVal">Активный</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Доступный баланс</td>
<td class="tdFieldVal"><span>100 000.00 €</span></td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">В т.ч. собственных средств</td>
<td class="tdFieldVal">100 000.00 €</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">В т.ч. средств за счет овердрафта</td>
<td class="tdFieldVal">0.00 €</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Зарезервировано (расход)</td>
<td class="tdFieldVal"><span data-filter="Зарезервировано (расход)" data-crid="40817978300000055322" class="cp-link" data-action="get-statement-with-filter">0.00 €</span></td>
</tr>
<tr>
<td class="whitespace"> </td>
<td class="tdFieldName">Зарезервировано (поступления)</td>
<td class="tdFieldVal"><span data-filter="Зарезервировано (приход)" data-crid="40817978300000055322" class="cp-link" data-action="get-statement-with-filter">0.00 €</span></td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Задолженность по комиссиям</td>
<td class="tdFieldVal">0.00 €</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Перерасход (несанкционированный овердрафт)</td>
<td class="tdFieldVal">0.00 €</td>
</tr>
</tbody></table></body></html>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body><table xmlns:com="http://schemas.tranzaxis.com/common-types.xsd" data-page-item="" crid="40817978300000055322" class="tblBlock tbl-inform" cellspacing="0" border="0" data-contract-properties='{"TypeId":"889","Id":"102235","Rid":"40817978300000055322","Status":"Active","Ccy":"978"}' data-contract-extra-properties='{"hasPayrollLink":false}'><tbody>
<tr class="trHeader"><th colspan="6" class="blockName"><div class="row">
<div class="small-3 column caption-table contract">
<div class="caption-text">Счёт</div>
<div class="caption-hint">40817978300000055322</div>
</div>
<div class="small-2 column wrapper-moreaction right"><div class="row"><div class="small-4 column right">
<div title="Дополнительно" data-dropdown="drop-action" data-options="align:left" class="information open" aria-expanded="true"></div>
<ul data-dropdown-content="" class="f-dropdown dropdown-list moreaction open drop-left f-open-dropdown" id="drop-action" style="position: absolute; left: -185px; top: 0px;" aria-hidden="false">
<li class="pic"><div><div class="text">Баланс</div></div></li>
<li><div class="leger-balance text-right"><div id="moreContractLedgerBalance102235" class="">
<div>100 000.00 €</div>
<div>
<span title="примерно">≈</span>9 099 000.00 ₽</div>
<div>
<span title="примерно">≈</span>122 380.00 $</div>
</div></div></li>
<li data-crid="40817978300000055322" class="pic operhist cp-action" data-action="get-statement"><div class="text">Список операций</div></li>
<li data-crid="40817978300000055322" class="pic bankdetails cp-action" data-action="show-bank-details"><div class="text">Реквизиты банка</div></li>
<li data-crid="40817978300000055322" class="pic dotransfer cp-action" data-action="make-transfer"><div class="text">Сделать перевод</div></li>
<li data-app-id="445" data-crid="40817978300000055322" data-action="application-withdrawal" class="pic cp-action create-application"><div class="text">Заказ денежных средств</div></li>
<li class="pic cp-action application-order" data-action="CMI::ContractsApplicationOrder:1"><div class="text">Заказ справки об остатке</div></li>
</ul>
</div></div></div>
</div></th></tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Описание счёта</td>
<td class="tdFieldVal"><div class="row" id="contract-title">
<div class="small-11 column" id="lnkContractTitle" ctitle="Счёт EUR">Счёт EUR</div>
<div class="small-1 column edit" data-action="change-contract-title"></div>
</div></td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Валюта</td>
<td class="tdFieldVal">Евро</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Дата создания</td>
<td class="tdFieldVal">01.01.2020</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Статус</td>
<td class="tdFieldVal">Активный</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Доступный баланс</td>
<td class="tdFieldVal"><span>100 000.00 €</span></td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">В т.ч. собственных средств</td>
<td class="tdFieldVal">100 000.00 €</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">В т.ч. средств за счет овердрафта</td>
<td class="tdFieldVal">0.00 €</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Зарезервировано (расход)</td>
<td class="tdFieldVal"><span data-filter="Зарезервировано (расход)" data-crid="40817978300000055322" class="cp-link" data-action="get-statement-with-filter">0.00 €</span></td>
</tr>
<tr>
<td class="whitespace"> </td>
<td class="tdFieldName">Зарезервировано (поступления)</td>
<td class="tdFieldVal"><span data-filter="Зарезервировано (приход)" data-crid="40817978300000055322" class="cp-link" data-action="get-statement-with-filter">0.00 €</span></td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Задолженность по комиссиям</td>
<td class="tdFieldVal">0.00 €</td>
</tr>
<tr>
<td class="whitespace"></td>
<td class="tdFieldName">Перерасход (несанкционированный овердрафт)</td>
<td class="tdFieldVal">0.00 €</td>
</tr>
</tbody></table></body></html>


require 'json'
require 'watir'
require 'nokogiri'
require_relative 'account'
class Neiva

  attr_accessor :browser, :accounts
  def initialize
    @browser = Watir::Browser.new :chrome
    @account_ids = []
    @array_text = []
  end

  def start
    goto_bank_page
    @account_ids = get_account_ids  
    parse_accounts
  end

  def goto_bank_page
  browser.goto('demo.bank-on-line.ru')
  browser.window.maximize
  # sleep 5
  browser.div(text: 'Войти').wait_until(&:present?).click
    # закрываю окошко насчет смены пароля, раньше его не было, пришлось добавить строчку
  browser.element(css: '#changePwdLater').wait_until(&:present?).click
  browser.div(data_layout: 'navbar').wait_until(&:present?).click
  sleep 2
  end

# получаем список номеров аккаунтов
  def get_account_ids
    account_ids = browser.lis.map do |li|
      li.attributes[:data_contract_r_id]
    end
# удаляю ненужные элементы из массива( все нилы, повторяющиеся и не соответствующие параметрам счета)
    account_ids.compact!
    account_ids.uniq!
    account_ids.delete_if {|n| n.size != 20}
    # puts account_ids
    # account_ids
  end

  def parse_accounts
    browser.element(css: '#lnkContracts').wait_until(&:present?).click
    @accounts = []
    @account_ids.map do |account_id|
      browser.tr(data_c_r_id: /#{account_id}/).wait_until(&:present?).click
      html =  browser.table(crid: /#{account_id}/).wait_until(&:present?).html
      account_information = Nokogiri::HTML.parse(html)
      # accounts << parse_account(account_info, acc_id)
      # puts account_information.css(".caption-hint").text
      puts account_id
      account_information.css("[class='tdFieldVal']").each do |text|        
         @array_text << text
                
        end
        puts @array_text[1].text
        @array_text = []
      browser.back
    end
  end
  #   def parse_account(account_information, account_id)
  #   currency = account_information.css("[class='tdFieldVal]").text
  #   balance_text = account_info.css("[data-semantic='header-current-balance']").text
  #   balance = parse_curreny_and_balance(balance_text).last
  #   currency = parse_curreny_and_balance(balance_text).first

  #   Account.new(
  #     name: account_information.css("[class='caption-hint']").text,
  #     currency: currency,
  #     balance: balance,
  #     nature: "account",
  #     id: acc_id
  #   )
  # end

end
 Neiva.new.start
